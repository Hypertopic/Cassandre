<!doctype html>
<html>
  <head>
    <title>{{diary_name}} - {{name}}</title>
    {{>links}}
  </head>
  <body>
      <header>
        <nav id="header" class="{{>navbarstyle}} navbar-expand bd-navbar fixed-top">
          <ul class="navbar-nav mr-auto">
            <a class="d-inline-block btn navbar-btn" id="diary" title="{{diary_name}}">
              <svg class="bi" width="24" height="24" fill="currentColor">
                <use xlink:href="../style/bootstrap-icons.svg#book"/>
              </svg>
            </a>
            <a class="d-inline-block btn navbar-btn" id="diff" title="{{i18n.i_diff}}">
              <svg class="bi" width="24" height="24" fill="currentColor">
                <use xlink:href="../style/bootstrap-icons.svg#file-diff"/>
              </svg>
            </a>
            <a class="d-inline-block btn navbar-btn hidden" id="only_diff" title="{{i18n.i_only_diff}}">
              <svg class="bi" width="24" height="24" fill="currentColor">
                <use xlink:href="../style/bootstrap-icons.svg#file-diff-fill"/>
              </svg>
            </a>
            <a class="d-inline-block btn navbar-btn hidden" id="showNotModified" title="{{i18n.i_show-more}}">
              <svg class="bi" width="24" height="24" fill="currentColor">
                <use xlink:href="../style/bootstrap-icons.svg#file-text"/>
              </svg>
            </a>
            <a class="d-inline-block btn navbar-btn hidden" id="mdown" title="{{i18n.i_layout}}">
              <svg class="bi" width="24" height="24" fill="currentColor">
                <use xlink:href="../style/bootstrap-icons.svg#file-richtext"/>
              </svg>
            </a>
          </ul>
          {{>log}}
        </nav>
      </header>
      <div id="container" class='container-fluid h-100'>
        <div id="memo" class='row h-100'>
          {{#authorized}}
          <div class="d-none d-sm-block col-sm-4 col-md-3 col-xl-2 pb-5" id="groundings">
            <legend>{{i18n.i_versions.legend}}</legend>
          </div>
          {{/authorized}}
          <main class="col pb-0 pb-sm-5" id="content">
            {{^authorized}}
            <h1>{{i18n.i_sign-in_required}}</h1>
            {{/authorized}}
            {{#authorized}}
            <div id="bodies">
              <div class="version" id="v{{current}}">
                <h2>{{name}}</h2><div class="content">{{body}}</div>
              </div>
            </div>
            {{/authorized}}
          </main>
        </div>
      </div>
      <nav id="footer" class="{{>navbarstyle}} fixed-bottom">
        {{#authorized}}
        <div role="group">
          <button type="button" class="btn btn-outline-{{>contrastcolor}} btn-sm" id="cancel">{{i18n.i_versions.keep-current}}</button>
          {{#editable}}<button type="button" class="btn btn-outline-{{>contrastcolor}} btn-sm d-none" id="revert">{{i18n.i_versions.revert}}</button>{{/editable}}
        </div>
        {{/authorized}}
        <a class="navbar-text" href="https://github.com/Hypertopic/Cassandre/wiki">
          <svg class="bi" width="24" height="24" fill="currentColor">
            <use xlink:href="../style/bootstrap-icons.svg#info-circle"/>
          </svg>
        </a>
      </nav>
  {{>script}}
  <script src="../script/revert.js"></script>
  <script>
  let revisions = [], current = {{current}}, selected = current, fullnames = [],
      bodies = [{version: current, name: '{{name}}', body: $('#v'+current+' .content').text()}],
      converter = new showdown.Converter({
    parseImgDimensions: 'true',
    tables: 'true',
    tasklists: 'true',
    strikethrough: 'true'
  });
  {{#fullnames}}
  fullnames['{{user}}'] = '{{name}}'; 
  {{/fullnames}}
  converter.setFlavor('github');
  let this_id = "{{_id}}", this_type = "{{type}}", diary_id = "{{diary}}", last_content = ''
  $(document).ready(function() {
    $.ajax({
      url: '../rev/'+this_id+'/all/',
      type: "GET",
      dataType: "json"
    }).done(function(all){
      revisions = all._revs_info
      for (var s of revisions) {
        var t = s.rev.split('-')[0];
        if(s.status == 'available' && t != current)
          $('#bodies').append($('<div>', { class: 'version d-none', id: 'v'+t })); 
          $('#groundings').append($('<li>', { id: 'tab_'+t}));
      }
      var doc = {
        name: "{{{name}}}",
        history: [{'user': '{{user}}', 'date': '{{date}}'}]
      }
      $('#tab_'+current).append($('<button>', { class: "btn btn-outline-secondary active", html: version_tab(doc)}))
        .on('click', function(){showOnly($(this).prop('id').split('_')[1]); });
      for (var r of revisions) {
        if(r.status == 'available') {
          if (r.rev != "{{_rev}}") getPrevious(r.rev);
        } else {
          $('#tab_'+r.rev.split('-')[0]).remove();
        }
      }
      if ($('#groundings li').length == 1) {
        $('#groundings').append($('<div>', { text: "{{i18n.i_versions.single}}".replace('&#39;', "'")  }))
        $('#diff').addClass('hidden')
      }
    })
    {{#logged}}
    setSignoutTooltip('{{logged}}')
    {{/logged}}
    stickToHeader()
    $(document).ajaxStop(function () {
      mdownLayout()
      $(this).unbind('ajaxStop')
    })
  })
  {{>layoutscript}}
  {{>logscript}}
  </script>
  </body>
</html>
