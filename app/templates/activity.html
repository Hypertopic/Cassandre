<!doctype html>
<html>
  <head>
    <title>{{diary_name}} - {{i18n.i_activity}}</title>
    {{>links}}
    <link rel="stylesheet" href="../../style/cal-heatmap.css" />
  </head>
  <body id="watermark">
    <nav id="header" class="{{>navbarstyle}} navbar-expand bd-navbar fixed-top">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="text-light nav-link" id="diary">{{diary_name}}</a></li>
      </ul>
      {{>log}}
    </nav>
    <div id="container" class='container-fluid h-100'>
      <main class="col pb-5" id="content">
        <h1>{{i18n.i_activity}}</h1>
        <fieldset class="form-group">
          <legend class="col-form-label">
            <span class="navbar-text">{{i18n.i_filter}}</span>
            <a id="all-activity">{{i18n.i_all}}</a>
            <a id="only-created">{{i18n.i_creations}}</a>
            <a id="only-modified">{{i18n.i_modifications}}</a>
            <a id="only-commented">{{i18n.i_comments}}</a>
          </legend>
        </fieldset>
        <div id="cal-heatmap"></div>
        <div id="activity" title="{{i18n.i_activity}}">
        <div id="contributors">
          <span class="all">&nbsp;</span>
          <span class="commented d-none">{{#ncommented}}{{user}}&nbsp;({{n}}) {{/ncommented}}</span>
          <span class="created d-none">{{#ncreated}}{{user}}&nbsp;({{n}}) {{/ncreated}}</span>
          <span class="modified d-none">{{#nmodified}}{{user}}&nbsp;({{n}}) {{/nmodified}}</span>
        </div>
        <ul>
        </ul></div>
      </main>
      <nav id="footer" class="{{>navbarstyle}} fixed-bottom">
        <a class='navbar-text' href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </nav>
    </div>
  {{>script}}
  <script type="text/javascript" src="../../script/d3.min.js"></script>
  <script type="text/javascript" src="../../script/cal-heatmap.min.js"></script>
  <script>
  var refresh = true;
  let cal = new CalHeatMap(),
      all = {},
      created = {},
      commented = {},
      modified = {},
      pathes = [],
      end = new Date('{{end}}'),
      start = new Date(end.setFullYear(end.getFullYear() - 1));
  $(document).ready(function() {
    moment.locale('{{locale}}');
    stickToHeader();
    {{#activity}}
    if('{{date}}' > start.toJSON()) {
      all[moment('{{date}}').format('X')] = 1;
      {{#commented}}commented[moment('{{date}}').format('X')] = 1;{{/commented}}
      {{#created}}created[moment('{{date}}').format('X')] = 1;{{/created}}
      {{#modified}}modified[moment('{{date}}').format('X')] = 1;{{/modified}}
      if (pathes['{{modified_id}}'] == null) pathes['{{modified_id}}'] = "{{modified_path}}";
    }
    {{/activity}}
    if (Object.keys(created).length < 1) $('#only-created').hide();
    if (Object.keys(commented).length < 1) $('#only-commented').hide();
    if (Object.keys(modified).length < 1) $('#only-modified').hide();
    showMore("Z");
    if (Object.keys(all).length < 1) {
      $('#all-activity').parent().hide();
      $('h1').text('{{i18n.i_sign-in_required}}');
    } else {
      drawChart(all);
    }
  });

  $('#sort').on('change', function() {
    self.location = '?by=' + $('#sort').val();
  });

  $('#diary').on('click', function() {
    self.location = '../../memo/{{diary}}/?by=date';
  });

  function drawChart(data) {
    cal.init({
      domain: "week",
      subDomain: "day",
      subDomainDateFormat: function(date) {
        return moment(date).format("LL");
      },
      subDomainTitleFormat: {
        filled: "{count} {name}, {date}"
      },
      data: data,
      range: 53,
      start: start,
      end: end,
      itemName: ["contribution", "contributions"],
      domainLabelFormat: ""
    });
  }

  $('#all-activity').on('click', function() {
    $('#contributors').children().removeClass('d-none');
    $('#contributors .created').addClass('d-none');
    $('#contributors .modified').addClass('d-none');
    $('#contributors .commented').addClass('d-none');
    cal.update(all);
  });
  $('#only-created').on('click', function() {
    $('#contributors').children().removeClass('d-none');
    $('#contributors .all').addClass('d-none');
    $('#contributors .modified').addClass('d-none');
    $('#contributors .commented').addClass('d-none');
    cal.update(created);
  });
  $('#only-commented').on('click', function() {
    $('#contributors').children().removeClass('d-none');
    $('#contributors .all').addClass('d-none');
    $('#contributors .created').addClass('d-none');
    $('#contributors .modified').addClass('d-none');
    cal.update(commented);
  });
  $('#only-modified').on('click', function() {
    $('#contributors').children().removeClass('d-none');
    $('#contributors .all').addClass('d-none');
    $('#contributors .created').addClass('d-none');
    $('#contributors .commented').addClass('d-none');
    cal.update(modified);
  });

  function showMore(start) {
    $.ajax({
      url: "../../activity/{{diary}}/"+start,
      type: "GET",
      dataType: "json",
      success: function(data) {
        for (var i in data) {
          var li = '<li>'
            +'<span id="'+data[i].date+'" class="'+data[i].date+' moment"></span>, '
            +'<span class="'+data[i].user+'">'+data[i].user+'</span> ';
          if (typeof data[i].diary_label !== 'undefined') {
            if (typeof data[i].created   !== 'undefined') li += '{{i18n.i_created}} {{i18n.i_the-diary}}';
            if (typeof data[i].modified  !== 'undefined') li += '{{i18n.i_modified}} {{i18n.i_the-diary}}';
          } else {
            if (typeof data[i].commented !== 'undefined') li += '{{i18n.i_commented}}&nbsp;: ';
            if (typeof data[i].created   !== 'undefined') li += '{{i18n.i_created}} ';
            if (typeof data[i].modified  !== 'undefined') li += '{{i18n.i_modified}} ';
            li += '<a href="../../'+pathes[data[i].modified_id]+'/{{diary}}/'+data[i].modified_id+'">'+data[i].modified_name+'</a>';
          }
          li += '</li>';
          $("#activity ul").append(li);
        }
      }
    }).done(function(){
      momentRelative('#activity ul');
    });
  }

  {{>layoutscript}}
  {{>logscript}}
  </script>
  </body>
</html>

