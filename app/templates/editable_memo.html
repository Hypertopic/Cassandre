<!doctype html>
<html>
  <head>
    <title>{{diary_name}} - {{name}}</title>
    {{>links}}
    <link rel="stylesheet" href="../style/easymde.min.css" />
  </head>
  <body>
      <header>
        <nav id="header" class="{{>navbarstyle}} navbar-expand bd-navbar fixed-top">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item text-light">{{diary_name}}</li>
          </ul>
          {{>log}}
        </nav>
      </header>
      <div id="container" class='container-fluid h-100'>
        <div id="memo" class='row h-100'>
          {{#authorized}}
          <div class="col-3" id="groundings">
            <legend>{{i18n.i_groundings}}</legend>
            {{#groundings}}
            <li id="{{.}}" class="{{type}}">
              <h4 class="toggle">{{name}}</h4>
              <div class="preview">{{preview}}</div>
            </li>
            {{/groundings}}
          </div>
          {{/authorized}}
          <main class="col pb-0 pb-sm-5" id="content">
            {{^authorized}}
            <h1>{{i18n.i_sign-in_required}}</h1>
            {{/authorized}}
            {{#authorized}}
            <h1> <img src="../style/{{type}}.svg"/> {{name}}</h1>
            <p>
              <textarea id="body" cols="80" rows="20" type="text">{{body}}</textarea>
            </p>
            {{/authorized}}
          </main>
        </div>
      </div>
      <nav id="footer" class="{{>navbarstyle}} fixed-bottom">
        {{#authorized}}
        <button type="button" class='btn btn-outline-light btn-sm' id="done">{{i18n.i_done}}</button>
        {{/authorized}}
        <a class='navbar-text' href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </nav>

  <script src="../script/jquery.js"></script>
  <script src="../script/easymde.min.js"></script>
  <script>
  var placeHolder = [];
  placeHolder["field"] = {name : "{{i18n.i_name.field}}", content: "{{{i18n.i_content.field}}}"};
  placeHolder["interview"] = {name : "{{i18n.i_name.transcript}}", content: "{{{i18n.i_content.transcript}}}"};
  placeHolder["transcript"] = {name : "{{i18n.i_name.transcript}}", content: "{{{i18n.i_content.transcript}}}"};
  placeHolder["coding"] = {name : "{{i18n.i_name.coding}}", content: "{{{i18n.i_content.coding}}}"};
  placeHolder["theoretical"] = {name : "{{i18n.i_name.theoretical}}", content: "{{{i18n.i_content.theoretical}}}"};
  placeHolder["operational"] = {name : "{{i18n.i_name.operational}}", content: "{{{i18n.i_content.operational}}}"};
  placeHolder["storyline"] = {name : "{{i18n.i_name.storyline}}", content: "{{{i18n.i_content.storyline}}}"};
  $("#name").attr("placeHolder", placeHolder["{{type}}"]["name"]);

  var easymde = new EasyMDE({
    element: $("#body")[0],
    autosave: {
      enabled: true,
      uniqueId: "{{_id}}",
      delay: 1000,
      timeFormat: {locale: '{{locale}}'}
    },
    toolbar: ["bold", "italic", "strikethrough", "|", "heading-3", "unordered-list", "horizontal-rule", "|", "link", "image", "table", "|", "guide"],
    placeholder: placeHolder["{{type}}"]["content"],
    spellChecker: false
  });

  var warning = 'Save your content';
  $(document).ready(function() {
    stickToHeader();
    window.addEventListener("beforeunload", function (e) {
      if (warning != false) {
        (e || window.event).returnValue = warning;
        return warning;
      }
    });
    $(".input-group").addClass('hidden');
    if ($('#groundings li').length < 1) $("#groundings").addClass('hidden');
    $('#groundings').find('.toggle').next().slideToggle('fast');
    $.ajax({
      url: "../{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        var user = "{{peer}}";
        if ("{{logged}}") user = "{{logged}}";
        data.editing = {
          "user": user,
          "date": new Date().toJSON()
        };
        $.ajax({
          type: "PUT",
          url: "../{{_id}}",
          contentType: "application/json",
          data: JSON.stringify(data),
        });
      }
    });
  });

  function save(draft, toDoAfter) {
    warning = false;
    $.ajax({
      url: "../{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        data.body = easymde.value().replace(/ *\n/g, " \n");
        if (!data.history) data.history = [];
        var user = "{{peer}}";
        if ("{{logged}}") user = "{{logged}}";
        data.history.push({
          "user": user,
          "date": new Date().toJSON()
        });
        delete data.editing;
        $.ajax({
          type: "PUT",
          url: "../{{_id}}",
          contentType: "application/json",
          data: JSON.stringify(data),
          error: function(request) {
            alert(
              (JSON.parse(request.responseText).reason || request.responseText)
              + '\nCode ' + request.status
            );
          },
          success: toDoAfter
        });
      }
    });
  }

  $('#done').on('click', function() {
    save(false, function() {
      easymde.clearAutosavedValue();
      self.location = '../memo/{{diary}}/{{_id}}';
    });
  });

  {{>layoutscript}}
  {{>logscript}}
  </script>
  </body>
</html>
