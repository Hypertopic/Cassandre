<html>
  <head>
    {{>links}}
  </head>
  <body id="watermark">
    <div id="container">
      <div id="header" class="menu">
        {{>log}}
      </div>
      <div id="content">
        <h1>{{i18n.i_diaries}}</h1>
        <ul>
          {{#diaries}}
          <li>
            <b>{{name}}</b>&nbsp;â€“
            <a href='../memo/{{id}}/?by=date'>{{count}} {{i18n.i_memos}}</a>
          </li>
          {{/diaries}}
        </ul>
        <div id="dialog" title="{{i18n.i_enter_diary_name}}" hidden="hidden">
          <input name="diary" placeholder="{{i18n.i_my_diary}}"></input>
        </div>
      </div>
      <div id="footer" class="menu">
        {{#logged}}
        <button type="button" id="create" class="theoretical"> + </button>
        {{/logged}}
        <a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </div>
    </div>
  </body>
  {{>script}}
  <script>
  var refresh = true;
  $(document).ready(function() {
    stickToHeader();
  });

  $('#create').on('click', function() {
    $("#dialog").dialog({
      autoOpen:false,
      modal:true,
      width:'auto',
      autoResize: true,
      buttons:{
        "ok":function(){
          $(this).dialog("close");
          var diary_name = $('#dialog').find('input[name="diary"]').val().trim();
          createDiary(diary_name);
          return true;
        },
        "cancel":function(){
          $(this).dialog("close");
          return false;
        }
      },
      open: function() {
        $("#dialog").keypress(function(e) {
          if (e.keyCode == $.ui.keyCode.ENTER) {
            $(this).parent().find("button:eq(1)").trigger("click");
          }
        });
      }
    });
    $("#dialog").dialog("open");
  });

  function createDiary(diary_name) {
    var type = $('#create')[0].className;
    var date = new Date().toJSON();
    var user = "{{peer}}";
    if ("{{logged}}") user = "{{logged}}";
    var diary = {
      diary_name: diary_name,
      history: [{
        "user": user,
        "date": date
      }]
    };
    var data = {
      contributors: [],
      readers: [],
      type: type,
      groundings: [],
      history: [{
        "user": user,
        "date": date
      }],
      name: "{{i18n.i_name.theoretical}}",
      body: ""
    };
    if ("{{logged}}") {
      data.contributors.push("{{logged}}");
    }
    if (diary_name) {
      $.ajax({
        url: "../",
        type: "POST",
        dataType: "json",
        contentType: "application/json",
        data: JSON.stringify(diary),
        success: function(diary) {
          data.diary = diary.id;
          $.ajax({
            url: "../",
            type: "POST",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function(data) {
              location.replace('../editable_memo/'+data.id)
            }
          });
        }
      });
    }
  };

  {{>layoutscript}}
  {{>logscript}}
  </script>
</html>

