<!doctype html>
<html>
  <head>
    <title>{{diary_name}}</title>
    {{>links}}
    {{^list}}
      {{>viscss}}
    {{/list}}
  </head>
  <body id="watermark">
    <nav id="header" class="{{>navbarstyle}} navbar-expand-md fixed-top">
      <a class="text-light" id="diaries">{{i18n.i_diaries}}</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="text-light bg-dark"><img src="../../style/three-bars.svg" alt="=" /></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <li class="form-inline justify-content-between">
            <div class="dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="show" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              {{i18n.i_show}}
              </a>
              <div class="dropdown-menu" aria-labelledby="show">
                <a class="dropdown-item" id="drawNetwork">{{i18n.i_network}}</a>
                <a class="dropdown-item" id="drawTimeline">{{i18n.i_timeline}}</a>
                {{#logged}}
                <h6 class="dropdown-header">{{i18n.i_export}}</h6>
                <a class="dropdown-item" href="../../export/{{diary}}/html">html</a>
                <a class="dropdown-item" href="../../export/{{diary}}/json">json</a>
                <a class="dropdown-item" href="../../export/{{diary}}/xml">xml</a>
                {{/logged}}
              </div>
            </div>
            <div class="dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="sort" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              {{i18n.i_sort}}
              </a>
              <div class="dropdown-menu" aria-labelledby="sort">
                <a class="dropdown-item" href="?by=name">{{i18n.i_title}}</a>
                <a class="dropdown-item" href="?by=date">{{i18n.i_date}}</a>
                <a class="dropdown-item" href="?by=update">{{i18n.i_update}}</a>
                <a class="dropdown-item" href="?by=type">{{i18n.i_type}}</a>
              </div>
            </div>
            <a class="nav-link hidden" id="patterns">{{i18n.i_patterns}}</a>
          </li>
        </ul>
        <ul class="navbar-nav justify-content-between">
          <li class="form-inline justify-content-between">
            <div></div>
            {{>log}}
          </li>
        </ul>
      </div>
    </nav>
    <div id="container" class='container-fluid'>
      <div id="content" class='col'>
        <h1>{{diary_name}}
          <span id="size" class="badge badge-pill badge-secondary" title="{{i18n.i_memos}}"></span>
          <span id="comments" class="badge badge-pill badge-info" title="{{i18n.i_unchecked-comment}}"></span>
        </h1>
        <input id="name" type="search" class="form-control hidden" value="{{diary_name}}"/>
        <div id="top-right">
          <img id="show-activity" src="../../style/history.svg" alt="{{i18n.i_activity}}" title="{{i18n.i_activity}}"/>
        </div>
        {{#list}}
        <div id="tasklist-alert" class="alert alert-primary hidden" title="{{i18n.i_tasklist}}">
          {{i18n.i_tasklist-alert}}
          <img src="../../style/tasklist.svg" alt="{{i18n.i_tasklist}}"/>
        </div>
        {{/list}}
        <div id="network" class="hidden"></div>
        <ul id="memos">
        {{#sections}}
          {{#memos}}
          <li class="{{type}}"><input type="checkbox" id="{{id}}" name="{{rev}}" class="hidden deletable" />
            <span id="{{date}}" name="{{update}}" class="moment unread"></span>&nbsp;â€“
            <span class="mytooltip">
              <a href="../../{{path}}/{{diary}}/{{id}}" class="unread">{{name}}</a>
              {{#preview}}<span class="preview text-light bg-dark">{{preview}}</span>{{/preview}}
            </span>
          </li>
          {{/memos}}
        {{/sections}}
        </ul>
      </div>
    </div>
    <nav id="footer" class="{{>navbarstyle}} fixed-bottom">
      <a class='navbar-text' href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
    </nav>
  {{>script}}
  {{#list}}<script src="../../script/showdown.min.js"></script>{{/list}}
  {{^list}}<script src="../../script/vis.min.js"></script>{{/list}}
  <script>
  var refresh = true;
  $(document).ready(function() {
    moment.locale('{{locale}}');
    stickToHeader();
    resetUI();
    {{#list}}
    momentRelative('#memos');
    var converter = new showdown.Converter({
      tables: 'true',
      tasklists: 'true',
      strikethrough: 'true'
    });
    converter.setFlavor('github');
    $('.preview').html(function(i, text) {
      return converter.makeHtml(text.trim());
    });
    $('#size').html($('#memos>li').length);
    if ('{{logged}}') $.ajax({
      url: "../../{{logged}}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        if(data.fullname) $('#username').text(data.fullname);
        for (i in data.activity) {
          var id = '#'+data.activity[i].doc;
          if (data.activity[i].date > $(id).parent().find('.moment').attr('name')) {
            $(id).parent().find('.unread').removeClass('unread');
          }
        }
        if ($('a.unread').length > 0) {
          $('#size').prepend($('a.unread').length+'/');
          $('#size').removeClass("badge-secondary");
          $('#size').addClass("badge-success");
          $('#size').attr("title", "{{i18n.i_memos-number}}");
        }
      }
    });
    $('.theoretical').attr('title',"{{i18n.i_memo.theoretical}}");
    $('.operational').attr('title',"{{i18n.i_memo.operational}}");
    $('.field').attr('title',"{{i18n.i_memo.field}}".replace('&#39;',"'"));
    $('.transcript').attr('title',"{{i18n.i_memo.transcript}}".replace('&#39;',"'"));
    $('.coding').attr('title',"{{i18n.i_memo.coding}}");
    $('.theoretical').attr('title',"{{i18n.i_memo.theoretical}}");
    $('.storyline').attr('title',"{{i18n.i_memo.storyline}}");
    $('.graph').attr('title',"{{i18n.i_memo.graph}}");
    $('.diagram').attr('title',"{{i18n.i_memo.diagram}}");
    $('.table').attr('title',"{{i18n.i_memo.table}}");
    {{/list}}
    {{#network}}
      drawNetwork();
    {{/network}}
    {{#timeline}}
      drawTimeline();
    {{/timeline}}
    $.ajax({
      url: "../../tasklist/{{diary}}",
      type: "GET",
      dataType: "json",
      success: function(todo) {
        if (todo.pending > 0) $('#tasklist-alert').removeClass("hidden");
        if (todo.comments > 0) $('#comments').prepend(todo.comments);
      }
    });
    $.ajax({
      url: "../../kwic/{{diary}}",
      type: "GET",
      dataType: "json",
      success: function(kwic) {
        if (kwic.pending > 0) $('#patterns').removeClass("hidden");
      }
    });
    $.ajax({
      url: "../../changes/diary/{{_id}}/{{update_seq}}",
      type: "GET",
      dataType: "json",
      success: reload
    });
  });

  $('#header')
    .on('click', '#diaries', function() {
      self.location = '..';
    })
    .on('click', '#drawNetwork', function() {
      self.location = '?by=network';
    })
    .on('click', '#drawTimeline', function() {
      self.location = '?by=timeline';
    })
    .on('click', '#patterns', function() {
      self.location = '../../kwic/{{diary}}';
    });

  $('#footer')
    .on('click', '#show_delete', function() {
      $("#network").addClass("hidden");
      $("#memos>li>input").removeClass("hidden");
      $("#footer").html(
        '<div role="group">'
        + '<button class="btn navbar-btn btn-outline-light btn-sm" id="cancel" type="button">{{i18n.i_cancel}}</button>'
        + '<input id="toggle" type="checkbox"><span class="navbar-text">{{i18n.i_select}}</span></input>'
        + '<button class="btn navbar-btn btn-outline-light btn-sm" id="delete" type="button">{{i18n.i_delete}}</button>'
        + '</div>'
      );
    })

    .on('click', '#cancel', function() {
      resetUI();
    })

    .on('click', '#toggle', function() {
      var checked = $("#toggle").is(":checked");
      $("input[type='checkbox']").each(function() {
        $(this).prop("checked", checked);
      });
    })

    .on('click', '#delete', function() {
      var checked = $("input.deletable:checked");
      var countdown = checked.size();
      if (!countdown) {
        resetUI();
      }
      checked.each(function() {
        var memo = $(this).closest(".memo");
        $.ajax({
          type: "DELETE",
          url: "../../" + $(this).attr("id") + "?rev=" + $(this).attr("name"),
          success: function() {
            countdown--;
            if (countdown<1) {
              location.reload();
            }
          }
        });
      });
    });

  $('#tasklist-alert').on('click', function() {
    self.location = "../../tasklist/{{diary}}/";
  });

  $('#show-activity').on('click', function() {
    self.location = "../../activity/{{diary}}/";
  });

  function resetUI() {
    $("#memos>li>input").addClass("hidden");
    $("#footer").html(
      '<button class="btn navbar-btn btn-outline-light btn-sm" type="button" id="show_delete">{{i18n.i_delete}}...</button>'
      + '<a class="navbar-text" href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>'
    );
  }

  {{#list}}
  function momentRelative(what) {
    var moments = $(what+' .moment');
    moments.each(function() {
      var now = moment();
      var jstime = $(this).attr('id');
      var mmtime = moment(jstime);
      if(now.diff(mmtime, 'days') <= 2) {
        $(this).text(mmtime.fromNow());
      } else if(now.diff(mmtime, 'years') < 1) {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM"));
      } else {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM YYYY"));
      }
    });
    var contributions = $('ul li .moment');
    contributions.each(function() {
      $(this).text($(this).text().replace(/./, function(x) { return x.toUpperCase(); }));
    });
  }
  {{/list}}

  {{#timeline}}
  function drawTimeline() {
    $("#footer").addClass("hidden");
    $(".vis-network").addClass("hidden");
    var container = document.getElementById('network');
    var data = {{{timeline}}};
    var options = {locale: '{{locale}}'};
    var groups = new vis.DataSet([
      {id: 0, content: '<img src="../../style/theoretical.svg" />', value: 0},
      {id: 1, content: '<img src="../../style/operational.svg" />', value: 1},
      {id: 2, content: '<img src="../../style/field.svg" />', value: 2},
      {id: 3, content: '<img src="../../style/coding.svg" />', value: 3},
      {id: 4, content: '<img src="../../style/diagram.svg" />', value: 4},
      {id: 5, content: '<img src="../../style/graph.svg" />', value: 5},
      {id: 6, content: '<img src="../../style/storyline.svg" />', value: 6},
      {id: 8, content: '<img src="../../style/table.svg" />', value: 8}
    ]);
    timeline = new vis.Timeline(container, data, options);
    timeline.setGroups(groups);
    timeline.on('click', function (selected) {
      if (selected.group == 4) {
        self.location = '../../diagram/{{diary}}/'+selected.item;
      } else if (selected.group == 8) {
        self.location = '../../table/{{diary}}/'+selected.item;
      } else if (selected.group == 5) {
        self.location = '../../graph/{{diary}}/'+selected.item;
      } else if (selected.item !== null) {
        self.location = selected.item;
      }
    });
    $("#memos").addClass("hidden");
    $("#network").removeClass("hidden");
  }
  {{/timeline}}

  {{#network}}
  function drawNetwork() {
    $("#footer").addClass("hidden");
    var diagrams = "{{{diagrams}}}";
    diagrams = diagrams.split(',');
    var graphs = "{{{graphs}}}";
    graphs = graphs.split(',');
    var tables = "{{{tables}}}";
    tables = tables.split(',');
    var container = document.getElementById('network');
    var data = {{{network}}};
    var options = {
      nodes: {
        shape: 'box',
        color: {
          background: 'white',
          highlight: {
            background: 'white'
          }
        }
      },
      edges: {
        color: 'blue'
      },
      layout: {
        hierarchical: {
          sortMethod: 'directed'
        }
      },
      interaction: {
        navigationButtons: true,
        keyboard: true
      }
    };
    network = new vis.Network(container, data, options);
    network.on('click', function (selected) {
      if (selected.nodes[0].length == 32) {
        if($.inArray(selected.nodes[0], diagrams) != -1) {
          self.location = '../../diagram/{{diary}}/'+selected.nodes[0];
        } else if($.inArray(selected.nodes[0], tables) != -1) {
          self.location = '../../table/{{diary}}/'+selected.nodes[0];
        } else if($.inArray(selected.nodes[0], graphs) != -1) {
          self.location = '../../graph/{{diary}}/'+selected.nodes[0];
        } else {
          self.location = selected.nodes[0];
        }
      }
    });
    $("#memos").addClass("hidden");
    $("#network").removeClass("hidden");
  }
  {{/network}}

  {{>layoutscript}}
  {{>logscript}}
  {{>editname}}
  </script>
  </body>
</html>

