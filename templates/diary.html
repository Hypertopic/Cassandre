<html>
  <head>
    <title>{{diary_name}}</title>
    <link rel="icon" type="image/png" href="../../style/favicon.png" />
    <link rel="stylesheet" type="text/css" href="../../style/main.css" />
    <link rel="stylesheet" type="text/css" href="../../style/diagram.css" />
    <link rel="stylesheet" type="text/css" href="../../style/vis.min.css" />
  </head>
  <body id="watermark">
    <div id="container">
      <header>
        <div id="header" class="menu">
          <button type="button" id="diaries">{{i18n.i_diaries}}</button>
          <button type="button" id="drawNetwork">{{i18n.i_network}}</button>
          <button type="button" id="drawTimeline">{{i18n.i_timeline}}</button>
          <select id="sort">
            <option>{{i18n.i_sort}}</option>
            <option value="name">{{i18n.i_title}}</option>
            <option value="date">{{i18n.i_date}}</option>
            <option value="type">{{i18n.i_type}}</option>
          </select>
          <button type="button" id="patterns">{{i18n.i_patterns}}</button>
          <div id='logged'>
          {{^logged}}
            <form id="signin">
              <input type="text" name="name" placeholder="{{i18n.i_username}}"/>
              <input type="password" name="password" placeholder="{{i18n.i_password}}"/>
              <button type="submit">{{i18n.i_sign-in}}</button>
            </form>
          {{/logged}}
          {{#logged}}
            {{logged}}
            <button id="signout">{{i18n.i_sign-out}}</button>
          {{/logged}}
          </div>
        </div>
      </header>
      <div id="content">
        <h1>{{diary_name}}</h1>
        <input id="diary_name" type="search" hidden="hidden" value="{{diary_name}}"/>
        <div id="add-leaves">
          <img id="sticky" src="../../style/checklist.png" hidden="hidden" alt="{{i18n.i_todo}}"/>
          <img id="show-activity" src="../../style/clock.png" alt="{{i18n.i_activity}}"/>
        </div>
        <div id="todo" hidden="hidden"></div>
        <div id="network" hidden="hidden"></div>
        <ul id="memos" hidden="hidden">
        {{#sections}}
          {{#memos}}
          <li class="{{type}}"> {{date}}&nbsp;–
            <a href="{{id}}" class="tooltip">{{name}}
            {{#preview}}<span class="preview">{{preview}}</span>{{/preview}}</a>
          </li>
          {{/memos}}
        {{/sections}}
        </ul>
        <ul id="selectable-memos" hidden="hidden">
        {{#sections}}
          {{#memos}}
          <li class="{{type}}"> <input type="checkbox" id="{{id}}" name="{{rev}}" />{{date}}&nbsp;–
            <a class="memo">{{name}}</a>
          </li>
          {{/memos}}
        {{/sections}}
        </ul>
      </div>
      <div id="footer" class="menu">
        <a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </div>
    </div>
  </body>
  <script src="../../script/jquery.js"></script>
  <script src="../../script/jquery-ui.min.js"></script>
  <script src="../../script/showdown.min.js"></script>
  <link rel="stylesheet" href="../../script/jquery-ui.min.css" />
  <script type="text/javascript" src="../../script/vis.min.js"></script>
  <script type="text/javascript" src="../../script/moment.min.js"></script>
  <script>
  $(document).ready(function() {
    moment.locale('{{locale}}');
    stickToHeader();
    resetUI();
    var converter = new showdown.Converter({
      tables: 'true',
      tasklists: 'true',
      strikethrough: 'true'
    });
    converter.setFlavor('github');
    $('.preview').html(function(i, text) {
      return converter.makeHtml(text.trim());
    });

    $.ajax({
      url: "../../tasklist/{{diary}}",
      type: "GET",
      dataType: "json",
      success: function(todo) {
        if (todo.pending > 0) $('#sticky').show();
      }
    });
  });

  $('#sort').on('change', function() {
    self.location = '?by=' + $('#sort').val();
  });

  $('#header')
    .on('click', '#diaries', function() {
      self.location = '..';
    })
    .on('click', '#list', function() {
      resetUI();
    })
    .on('click', '#drawNetwork', function() {
      drawNetwork();
    })
    .on('click', '#drawTimeline', function() {
      drawTimeline();
    })
    .on('click', '#patterns', function() {
      self.location = '../../kwic/{{diary}}';
    });

  $('#footer')
    .on('click', '#show_delete', function() {
      $("#network").hide();
      $("#memos").hide();
      $("#selectable-memos").show();
      $("#footer").html(
        '<button id="cancel" type="button">{{i18n.i_cancel}}</button>'
        + '<input id="toggle" type="checkbox">{{i18n.i_select}}</button>'
        + '<button id="delete" type="button">{{i18n.i_delete}}</button>'
      );
    })

    .on('click', '#cancel', function() {
      resetUI();
    })

    .on('click', '#toggle', function() {
      var checked = $("#toggle").is(":checked");
      $("input[type='checkbox']").each(function() {
        $(this).prop("checked", checked);
      });
    })

    .on('click', '#delete', function() {
      var checked = $("input:checked");
      var countdown = checked.size();
      if (!countdown) {
        resetUI();
      }
      checked.each(function() {
        var memo = $(this).closest(".memo");
        $.ajax({
          type: "DELETE",
          url: "../../" + $(this).attr("id") + "?rev=" + $(this).attr("name"),
          success: function() {
            countdown--;
            if (countdown<1) {
              location.reload();
            }
          }
        });
      });
    });

  $('#sticky').on('click', function() {
    self.location = "../../tasklist/{{diary}}/";
  });

  $('#show-activity').on('click', function() {
    self.location = "../../activity/{{diary}}/";
  });
  $('#all-activity').on('click', function() {
    $(".created").show();
    $(".modified").show();
    $(".commented").show();
    showContributions();
  });
  $('#only-created').on('click', function() {
    $(".created").show();
    $(".modified").hide();
    $(".commented").hide();
    showContributions();
  });
  $('#only-comments').on('click', function() {
    $(".created").hide();
    $(".modified").hide();
    $(".commented").show();
    showContributions();
  });
  $('#only-modified').on('click', function() {
    $(".created").hide();
    $(".commented").hide();
    $(".modified").show();
    showContributions();
  });

  function showContributions() {
    var contributorlist = new Object ();
    var contributors = $('ul li span:visible');
    contributors.each(function() {
      var contributor = $(this).attr('class');
      if (contributor != 'moment') {
        if (contributorlist[contributor]) {
          contributorlist[contributor] = contributorlist[contributor] + 1;
        } else {
          contributorlist[contributor] = 1;
        }
      }
    });
    var n = '';
    for (var c in contributorlist) {
      if (contributorlist.hasOwnProperty(c)) {
        n += ' '+c+' ('+contributorlist[c]+')';
      }
    }
    document.getElementById("contributors").innerHTML = n;
  }

  function resetUI() {
    var listed = $("#memos>li");
    listed.each(function() {
      var type = $(this).attr('class');
      switch(type){
        case "graph":
        case "table":
        case "diagram":
          $(this).find('a').attr('href', '../../'+type+'/{{diary}}/'+$(this).find('a').attr('href'));
          break;
      }
    });
    $("#memos").show();
    $("#selectable-memos").hide();
    $("#network").hide();
    $("#footer").html(
      '<button type="button" id="show_delete">{{i18n.i_delete}}...</button>'
      + '<a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>'
    );
  }

  $(window).resize(function() {
    stickToHeader();
  });

  function momentRelative(what) {
    var moments = $(what+' .moment');
    moments.each(function() {
      var now = moment();
      var jstime = $(this).text();
      var mmtime = moment(jstime);
      if(now.diff(mmtime, 'days') <= 2) {
        $(this).text(mmtime.fromNow());
      } else if(now.diff(mmtime, 'years') <= 1) {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM"));
      } else {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM YYYY"));
      }
    });
    var contributions = $('ul li .moment');
    contributions.each(function() {
      $(this).text($(this).text().replace(/./, function(x) { return x.toUpperCase(); }));
    });
  }

  function stickToHeader() {
    var h = document.getElementById("header").offsetHeight;
    $("#container>#content h1").css({'padding-top': h+5});
    $("#container>#content #diary_name").css({'margin-top': h+5});
    $("#add-leaves").css({'top': h+5});
  }

  function drawTimeline() {
    $(".vis-network").hide();
    var container = document.getElementById('network');
    var data = {{{timeline}}};
    var options = {locale: '{{locale}}'};
    var groups = new vis.DataSet([
      {id: 0, content: '<img src="../../style/theoretical.png" />', value: 0},
      {id: 1, content: '<img src="../../style/operational.png" />', value: 1},
      {id: 2, content: '<img src="../../style/field.png" />', value: 2},
      {id: 3, content: '<img src="../../style/coding.png" />', value: 3},
      {id: 4, content: '<img src="../../style/diagram.png" />', value: 4},
      {id: 5, content: '<img src="../../style/graph.png" />', value: 5},
      {id: 6, content: '<img src="../../style/storyline.png" />', value: 6},
      {id: 8, content: '<img src="../../style/table.png" />', value: 8}
    ]);
    timeline = new vis.Timeline(container, data, options);
    timeline.setGroups(groups);
    timeline.on('click', function (selected) {
      if (selected.group == 4) {
        self.location = '../../diagram/{{diary}}/'+selected.item;
      } else if (selected.group == 8) {
        self.location = '../../table/{{diary}}/'+selected.item;
      } else if (selected.group == 5) {
        self.location = '../../graph/{{diary}}/'+selected.item;
      } else if (selected.item !== null) {
        self.location = selected.item;
      }
    });
    $("#todo").hide();
    $("#memos").hide();
    $("#network").show();
  }

  function drawNetwork() {
    var diagrams = "{{{diagrams}}}";
    diagrams = diagrams.split(',');
    var graphs = "{{{graphs}}}";
    graphs = graphs.split(',');
    var tables = "{{{tables}}}";
    tables = tables.split(',');
    var container = document.getElementById('network');
    var data = {{{network}}};
    var options = {
      nodes: {
        shape: 'box',
        color: {
          background: 'white',
          highlight: {
            background: 'white'
          }
        }
      },
      edges: {
        color: 'blue'
      },
      layout: {
        hierarchical: {
          sortMethod: 'directed'
        }
      },
      interaction: {
        navigationButtons: true,
        keyboard: true
      }
    };
    network = new vis.Network(container, data, options);
    network.on('click', function (selected) {
      if (selected.nodes[0].length == 32) {
        if($.inArray(selected.nodes[0], diagrams) != -1) {
          self.location = '../../diagram/{{diary}}/'+selected.nodes[0];
        } else if($.inArray(selected.nodes[0], tables) != -1) {
          self.location = '../../table/{{diary}}/'+selected.nodes[0];
        } else if($.inArray(selected.nodes[0], graphs) != -1) {
          self.location = '../../graph/{{diary}}/'+selected.nodes[0];
        } else {
          self.location = selected.nodes[0];
        }
      }
    });
    $("#todo").hide();
    $("#memos").hide();
    $("#network").show();
  }

  var reload = function() {
    location.reload();
  };

  $('#signin').on('submit', function(e) {
    e.preventDefault();
    $(this).find('input').first().val($(this).find('input').first().val().toLowerCase());
    $.post('/_session', $(this).serialize(), reload);
  });

  $('#signout').on('click', function() {
    $.ajax({
      type: 'DELETE',
      url: '/_session',
      success: reload
    });
  });

  $('h1').on('click', function() {
    $(this).hide();
    $('#diary_name').show();
  });

  $('#diary_name').on('keypress', function(key) {
    if (key.which == 13) {
      var diary_name = $('#diary_name').val().trim();
      var user = "{{peer}}";
      if ("{{logged}}") user = "{{logged}}";
      var history = {
        "user": user,
        "date": new Date().toJSON()
      };
      $.ajax({
        url: "../../{{diary}}",
        type: "GET",
        dataType: "json",
        error: function() {
          $.ajax({
            type: "PUT",
            url: "../../{{diary}}",
            dataType: "json",
            contentType: "application/json",
            data: JSON.stringify({
              _id: "{{diary}}",
              diary_name: diary_name,
              history: [history]
            }),
            success: reload
          });
        },
        success: function(data) {
          data.diary_name = diary_name;
          if (!data.history) data.history = [];
          data.history.push(history);
          $.ajax({
            type: "PUT",
            url: "../../{{diary}}",
            contentType: "application/json",
            data: JSON.stringify(data),
            error: function(request) {
              alert(
                (JSON.parse(request.responseText).reason || request.responseText)
                + '\nCode ' + request.status
              );
            },
            success: reload
          });
        }
      });
    }
  });

  </script>
</html>

