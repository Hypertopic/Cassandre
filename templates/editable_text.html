<!doctype html>
<html>
  <head>
    {{>links}}
  </head>
  <body id="watermark">
    <form id="container">
      <header>
        <nav id="header" class="{{>navbarstyle}} navbar-expand bd-navbar fixed-top">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item"><a class="nav-link" id="corpus">&nbsp;</a></li>
          </ul>
          {{>log}}
        </nav>
      </header>
      <div id="memo" class='col'>
        {{^authorized}}
        <h1>{{i18n.i_sign-in_required}}</h1>
        {{/authorized}}
        {{#authorized}}
        <fieldset id="attributes">
          <input id="_id" type="hidden" value="{{_id}}" />
          <input id="_rev" type="hidden" value="{{_rev}}" />
          <input id="corpus" type="hidden" value="{{corpus}}" />
        </fieldset>
        <h1> <img src="../style/transcript.svg"/>
          {{#attributes}}
          <span id="{{key}}" type="text" >{{value}}</span>
          {{/attributes}}
        </h1>
        <table>
          {{#speeches}}
          <tr class="turn">
            <td class="actor">
              <input type="text" value="{{actor}}"
                placeHolder="{{i18n.i_actor}}" />
            </td>
            <td class="speech">
              <textarea cols="80" rows="3" type="text"
                placeHolder="{{{i18n.i_content.transcript}}}">{{text}}</textarea>
            </td>
            <td>
              <a class="remove" href="#">x</a>
              <a class="insert" href="#">+</a>
            </td>
          </tr>
          {{/speeches}}
        </table>
        {{/authorized}}
      </div>
      <nav id="footer" class="{{>navbarstyle}} fixed-bottom">
        {{#authorized}}
        <div role="group">
          <button type="button" class='btn btn-outline-light btn-sm' id="save">{{i18n.i_save}}</button>
          <button type="button" class='btn btn-outline-light btn-sm' id="done">{{i18n.i_done}}</button>
        </div>
        {{/authorized}}
        <a class='navbar-text' href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </nav>
    </form>
  <script src="../script/jquery.js"></script>
  <script>
  $(document).ready(function() {
    $.ajax({
      url: "../{{corpus}}",
      type: "GET",
      dataType: "json",
      success: function(d) {
        $("#corpus").html(d.diary_name);
      }
    });
    stickToHeader();
  });

  function save(draft, toDoAfter) {
    $.ajax({
      url: "../{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        if (draft) {
          data.draft = true;
        } else {
          data.draft = false;
        }
        data.speeches = [];
        $('.turn').each(function() {
          var turn = {
            text: $(this).find('textarea').val()
          };
          var actor = $(this).find('input').val();
          if (actor) {
            turn.actor = actor;
          }
          data.speeches.push(turn);
        });
        if (!data.history) data.history = [];
        data.history.push({
          "user": user,
          "date": new Date().toJSON()
        });
        $.ajax({
          type: "PUT",
          url: "../{{_id}}",
          contentType: "application/json",
          data: JSON.stringify(data),
          error: function(request) {
            alert(
              (JSON.parse(request.responseText).reason || request.responseText)
              + '\nCode ' + request.status
            );
          },
          success: toDoAfter
        });
      }
    });
  }

  $('#corpus').on('click', function() {
    self.location = '../memo/{{corpus}}/?by=date';
  });

  $('#save').on('click', function() {
    save(true, function() {
      location.reload();
    });
  });

  $('#done').on('click', function() {
    save(false, function() {
      self.location = '../memo/{{corpus}}/{{_id}}';
    });
  });

  $('#memo')
    .on('click', '.insert', function() {
      var current = $(this).closest('.turn');
      var next = current.clone()
      next.find('input').val(current.prev().find('input').val());
      next.find('textarea').val('');
      current.after(next);
      return false;
    })
    .on('click', '.remove', function() {
      var current = $(this).closest('.turn');
      if ($('.turn').length>1) {
        current.remove();
      } else {
        current.find('input').val('');
        current.find('textarea').val('');
      }
      return false;
    });

  {{>layoutscript}}
  {{>logscript}}
  </script>
  </body>
</html>
