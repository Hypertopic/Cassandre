<html>
  <head>
    <link rel="icon" type="image/png" href="../style/favicon.png" />
    <link rel="stylesheet" type="text/css" href="../style/main.css" />
  </head>
  <body id="watermark">
    <form id="container">
      <header>
        <div id="header" class="menu">
          <button type="button" id="corpus">&nbsp;</button>
          {{#logged}}
            {{logged_fullname}}
          <button id="signout">{{i18n.i_sign-out}}</button>
          {{/logged}}
        </div>
      </header>
      <div id="content">
        {{^authorized}}
        <h1>{{i18n.i_sign-in_required}}</h1>
        {{/authorized}}
        {{#authorized}}
        <fieldset id="attributes">
          <input id="_id" type="hidden" value="{{_id}}" />
          <input id="_rev" type="hidden" value="{{_rev}}" />
          <input id="corpus" type="hidden" value="{{corpus}}" />
        </fieldset>
        <h1> <img src="../style/field.png"/>
          {{#attributes}}
          <input id="{{key}}" type="text" placeHolder="{{i18n.i_name.field}}" value="{{value}}" />
          {{/attributes}}
        </h1>
        <table>
          {{#speeches}}
          <tr class="turn">
            <td class="actor">
              <input type="text" value="{{actor}}"
                placeHolder="{{i18n.i_actor}}" />
            </td>
            <td class="speech">
              <textarea cols="80" rows="3" type="text"
                placeHolder="{{{i18n.i_content.field}}}">{{text}}</textarea>
            </td>
            <td>
              <a class="remove" href="#">x</a>
              <a class="insert" href="#">+</a>
            </td>
          </tr>
          {{/speeches}}
        </table>
        {{/authorized}}
      </div>
      <div id="footer" class="menu">
        {{#authorized}}
        <button type="button" id="save">{{i18n.i_save}}</button>
        <button type="button" id="done">{{i18n.i_done}}</button>
        {{/authorized}}
        <a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </div>
    </form>
  </body>
  <script src="../script/jquery.js"></script>
  <script>
  $(document).ready(function() {
    $.ajax({
      url: "../{{corpus}}",
      type: "GET",
      dataType: "json",
      success: function(d) {
        $("#corpus").html(d.diary_name);
      }
    });
  });

  function save(draft, toDoAfter) {
    $.ajax({
      url: "../{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        if (draft) {
          data.draft = true;
        } else {
          data.draft = false;
        }
        $('#attributes').children('input').each(function() {
          data[$(this).attr('id')] = $(this).val();
        })
        data.name = $('#name').val();
        data.speeches = [];
        $('.turn').each(function() {
          var turn = {
            text: $(this).find('textarea').val()
          };
          var actor = $(this).find('input').val();
          if (actor) {
            turn.actor = actor;
          }
          data.speeches.push(turn);
        });
        if (!data.history) data.history = [];
        var user = "{{peer}}";
        if ("{{logged}}") user = "{{logged}}";
        data.history.push({
          "user": user,
          "date": new Date().toJSON()
        });
        $.ajax({
          type: "PUT",
          url: "../{{_id}}",
          contentType: "application/json",
          data: JSON.stringify(data),
          error: function(request) {
            alert(
              (JSON.parse(request.responseText).reason || request.responseText)
              + '\nCode ' + request.status
            );
          },
          success: toDoAfter
        });
      }
    });
  }

  $('#corpus').on('click', function() {
    self.location = '../memo/{{corpus}}/?by=date';
  });

  $('#save').on('click', function() {
    if ($('#name').val().trim() == '') {
      alert("{{i18n.i_enter_memo_name}}")
    } else {
      save(true, function() {
        location.reload();
      });
    }
  });

  $('#done').on('click', function() {
    if ($('#name').val().trim() == '') {
      alert("{{i18n.i_enter_memo_name}}")
    } else {
      save(false, function() {
        self.location = '../memo/{{corpus}}/{{_id}}';
      });
    }
  });

  $('#content')
    .on('click', '.insert', function() {
      var current = $(this).closest('.turn');
      var next = current.clone()
      next.find('input').val(current.prev().find('input').val());
      next.find('textarea').val('');
      current.after(next);
      return false;
    })
    .on('click', '.remove', function() {
      var current = $(this).closest('.turn');
      if ($('.turn').length>1) {
        current.remove();
      } else {
        current.find('input').val('');
        current.find('textarea').val('');
      }
      return false;
    });

  </script>
</html>
