<html>
  <head>
    <title> - {{name}}</title>
    <link rel="icon" type="image/png" href="../../style/favicon.png" />
    <link rel="stylesheet" type="text/css" href="../../style/main.css" />
    <link rel="stylesheet" type="text/css" href="../../style/diagram.css" />
    <link rel="stylesheet" type="text/css" href="../../style/vis.min.css" />
  </head>
  <body>
    <div id="container">
      <div id="header" class="menu">
        <button type="button" id="diary">&nbsp;</button>
        <div id='logged'>
        {{^logged}}
          <form id="signin">
            <input type="text" name="name" placeholder="username"/>
            <input type="password" name="password" placeholder="password"/>
            <button type="submit">{{i18n.i_sign-in}}</button>
          </form>
        {{/logged}}
        {{#logged}}
          {{logged}}
          <button id="signout">{{i18n.i_sign-out}}</button>
        {{/logged}}
        </div>
      </div>
      <div id="memo">
        {{#authorized}}
        <div id="groundings">
          <legend>{{i18n.i_groundings}}</legend>
          {{#groundings}}
          <li id="{{.}}">
            <h4 class="toggle"></h4>
            <div class="preview"></div>
          </li>
          {{/groundings}}
          <div id="add-grounding"></div>
        </div>
        {{/authorized}}
        <div id="content">
          {{^authorized}}
          <h1>{{i18n.i_sign-in_required}}</h1>
          {{/authorized}}
          {{#authorized}}
          <div id="add-leaves">
            <button type="button" class="storyline" id="add">+</button>
          </div>
          <h1> <img src="../../style/{{type}}.png"/> {{name}} </h1>
          <p id="authorization">
            {{i18n.i_created-by}} {{date}}<br/>
            {{i18n.i_contributors}} <span id="contributors">{{contributors}}</span><br/>
            {{i18n.i_readers}} <span id="readers">{{readers}}</span>
          </p>
          <div id="graph"></div>
          {{/authorized}}
        </div>
        <div id="leaves">
          <ul id="branch">
          </ul>
        </div>
      </div>
      <div id="footer" class="menu">
        <a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </div>
    </div>
    <div id="show-leaves" hidden="hidden"><div class="reverse">{{i18n.i_leaves}}</div></div>
    <div id="dialog" hidden="hidden">
        <select onChange="save(this);"></select>
    </div>
  </body>
  <script src="../../script/jquery.js"></script>
  <script src="../../script/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="../../script/jquery-ui.min.css" />
  <script type="text/javascript" src="../../script/vis.min.js"></script>
  <script>
  var user = "{{peer}}";
  if ("{{logged}}") user = "{{logged}}";
  $(document).ready(function() {
    if ($('#contributors').text().length < 1) {
      $('#contributors').before("{{i18n.i_everyone}}");
    }
    if ($('#readers').text().length < 1) {
      $('#readers').before("{{i18n.i_everyone}}");
    }
    $.ajax({
      url: "../../memo_attribute/{{diary}}",
      type: "GET",
      dataType: "json",
        success: function(grounds) {
        var nodelabel = [];
        for (var i in grounds.rows) {
          var r = grounds.rows[i];
          var diary = r.key;
          var id = '#' + r.value['id'];
          var ground_href = r.value['id'];
          var ground_type = r.value['type'];
          switch (ground_type) {
            case ('memo'): 
            var ground_path = "../../memo/{{diary}}/";
            break;
            case ('diagram'): 
            var ground_path = "../../diagram/{{diary}}/";
            break;
            default:
            var ground_path = '';
          } 
          var ground_label = r.value['name'];
          nodelabel[ground_href] = r.value['name'];
          var ground_date = r.value['date']; // unused
          var ground_preview = r.value['preview'];
          if(document.getElementById(ground_href) == null && ground_href != "{{_id}}" && ground_type == 'diagram') {
            $("#dialog").find('select').append($('<option>', {
              id: ground_href,
              value: ground_href,
              text: ground_label
            }));
          } else {
            $(id).addClass(ground_type);
            $(id).find("h4").text(ground_label);
            $(id).find("div").text(ground_preview);
            var link = document.createElement("a");
            link.setAttribute('href', ground_path+ground_href);
            $(id).find("div").append(link);
            $(id).find("div").find("a").text('->'); 
          };
        }
        var container = document.getElementById('graph');
        var nodes = new vis.DataSet([
          {{#nodes}}
          {id: "{{id}}", shape: "{{shape}}", label: nodelabel["{{id}}"] },
          {{/nodes}}
        ]); 
        var edges = new vis.DataSet([
          {{#edges}}
            {{^dashes}}{id: "{{id}}", from: "{{from}}", to: "{{to}}", color:"{{color}}" },{{/dashes}}
            {{#dashes}}{from: "{{from}}", to: "{{to}}", label:"{{label}}", dashes:true },{{/dashes}}
          {{/edges}}
        ]); 
        var data = {
          nodes: nodes,
          edges: edges
        };
        var options = {
          nodes: {
            color: {
              border: 'black',
              background: 'white',
              highlight:{
                border: 'black',
                background: 'white'
              }
            }
          }          
        };
        var network = new vis.Network(container, data, options);
        network.on('click', function (selected) {
          if (typeof selected.nodes[0] === "undefined" && selected.edges[0].length == 32) {  
            self.location = "../../diagram/{{diary}}/"+selected.edges[0];
          } else if (selected.nodes[0].length == 32) {
            self.location = "../../memo/{{diary}}/"+selected.nodes[0];
          } else {}
        });
      }
    });
    $('#add-grounding').html("{{i18n.i_add_groundings}}");
    $("#dialog").attr("title","{{i18n.i_groundings}}");
    $("#dialog").find('select').append($('<option>', {
      text: "{{i18n.i_select_grounding}}"
    }));
    $.ajax({
      url: "../../{{diary}}",
      type: "GET",
      dataType: "json",
      success: function(d) {
        $("#diary").html(d.diary_name);
        $('title').prepend(d.diary_name);
      }
    });
    $.ajax({
      url: "../../leaves/{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(leaves) {
        for (var i in leaves.rows) {
          var r = leaves.rows[i];
          var leaf_href = r.value['id'];
          var leaf_type = r.value['type'];
          var leaf_path = '';
          if (leaf_type != 'diagram') {
            var leaf_path = "../../memo/{{diary}}/";
          }
          var leaf_label = r.value['name'];
          $("#leaves ul").append('<li class="'+leaf_type+'"><a href="'+leaf_path+leaf_href+'">'+leaf_label+'</a></li>');              
        }
        if (leaves.rows.length > 0) {
          $("#show-leaves").show();
        }
      }
    }); 
  });

  $('#add').on('click', function() {
    var contributors = "{{contributors}}";
    var readers = "{{readers}}";
    var type = $(this)[0].className; 
    var data = {
      diary: "{{diary}}",
      type: type,
      groundings: [],
      name: "",
      history: []
    };
    data.history.push({
      "user": user,
      "date": new Date().toJSON()
    });
    if (contributors.length > 0) {
      data.contributors = contributors.split(',');
    } else if ("{{logged}}") {
      data.contributors = ["{{logged}}"];
    }
    if (readers.length > 0) {
      data.readers = readers.split(',');
    }
    data.groundings.push("{{_id}}");
    if (diary) {
      $.ajax({
        url: "../../",
        type: "POST",
        dataType: "json",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function(data) {
          self.location = '../../editable_memo/'+data.id;
        }
      });
    }
  });

  $('#groundings').find('.toggle').click(function(){
    $(this).next().slideToggle('fast');
    $(".preview").not($(this).next()).slideUp('fast');
  });

  $("#show-leaves").click(function () {
    var option = { direction: 'left' };
    $('#leaves').toggle('fold');
  });

  $('#diary').on('click', function() {
    self.location = '../../memo/{{diary}}/?by=name';
  });

  $('#add-grounding').on('click', function() {
    $("#dialog").dialog({
      autoOpen: true,
      modal: true,
      autoResize: true,
      width:'auto'
    });
  });

  function save(there) {
    $.ajax({
      url: "../../"+there.value,
      type: "GET",
      dataType: "json",
      error: function(request) {
        alert(
          (JSON.parse(request.responseText).reason || request.responseText)
          + '\nCode ' + request.status
        );
      },
      success: function(added) {
        var nodeids = [];
          {{#nodes}}
          nodeids.push("{{id}}");
          {{/nodes}}
        $.ajax({
          url: "../../{{_id}}",
          type: "GET",
          dataType: "json",
          success: function(data) {
            data.groundings.push(there.value);
            switch (added.link) {
              case ('pp'):
                if($.inArray(added.groundings[0], nodeids) == -1) {data.nodes.push({id: added.groundings[0], shape: 'box'});}
                if($.inArray(added.groundings[1], nodeids) == -1) {data.nodes.push({id: added.groundings[1], shape: 'box'});}
                data.edges.push({id: there.value, from: added.groundings[0], to: added.groundings[1], color: 'green'});
                break;
              case ('ipp'):
                if($.inArray(added.groundings[0], nodeids) == -1) {data.nodes.push({id: added.groundings[0], shape: 'box'});}
                if($.inArray(added.groundings[1], nodeids) == -1) {data.nodes.push({id: added.groundings[1], shape: 'box'});}
                data.edges.push({id: there.value, from: added.groundings[0], to: added.groundings[1], color: 'red'});
                break;
              case ('dd'):
                if($.inArray(added.groundings[0], nodeids) == -1) {data.nodes.push({id: added.groundings[0], shape: 'diamond'});}
                if($.inArray(added.groundings[1], nodeids) == -1) {data.nodes.push({id: added.groundings[1], shape: 'diamond'});}
                data.edges.push({id: there.value, from: added.groundings[0], to: added.groundings[1], color: 'green'});
                break;
              case ('idd'):
                if($.inArray(added.groundings[0], nodeids) == -1) {data.nodes.push({id: added.groundings[0], shape: 'diamond'});}
                if($.inArray(added.groundings[1], nodeids) == -1) {data.nodes.push({id: added.groundings[1], shape: 'diamond'});}
                data.edges.push({id: there.value, from: added.groundings[0], to: added.groundings[1], color: 'red'});
                break;
              case ('dp'):
                if($.inArray(added.groundings[0], nodeids) == -1) {data.nodes.push({id: added.groundings[0], shape: 'box'});}
                if($.inArray(added.groundings[1], nodeids) == -1) {data.nodes.push({id: added.groundings[1], shape: 'diamond'});}
                data.edges.push({id: there.value, from: added.groundings[0], to: added.groundings[1], color: 'green'});
                break;
            }
            if (added.negative) {
              data.edges.push({from: added.groundings[1], to: added.groundings[0], dashes: true, label: added.negative });
            }
            $.ajax({
              type: "PUT",
              url: "../../{{_id}}",
              contentType: "application/json",
              data: JSON.stringify(data),
              error: function(request) {
                alert(
                  (JSON.parse(request.responseText).reason || request.responseText)
                  + '\nCode ' + request.status
                );
              },
              success: function() {
                location.replace("{{_id}}")
              }
            });
          }
        });
      }
    });
  }
  </script>
</html>
