<!doctype html>
<html>
  <head>
    <title>{{diary_name}} - {{name}}</title>
    {{>links}}
    {{>diagramcss}}
    {{>viscss}}
  </head>
  <body>
    <nav id="header" class="{{>navbarstyle}} navbar-expand bd-navbar fixed-top">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item"><a class="nav-link" id="diary">{{diary_name}}</a></li>
      </ul>
      {{>log}}
    </nav>
    <div id="container" class='container-fluid h-100'>
      <div id="memo" class='row h-100'>
        {{#authorized}}
        <div class="col-3" id='groundings'>
          <legend>{{i18n.i_groundings}}</legend>
          {{#groundings}}
          <li class="{{type}}" id="{{id}}">
            <a href="{{href}}">{{name}}</a>
          </li>
          {{/groundings}}
        </div>
        {{/authorized}}
        <main class="col" id="content">
          {{^authorized}}
          <h1>{{i18n.i_sign-in_required}}</h1>
          {{/authorized}}
          {{#authorized}}
          <h1> <img title="{{i18n.i_memo.graph}}" src="../../style/{{type}}.svg"/> {{name}} </h1>
          <input id="name" type="search" class="form-control hidden" value="{{name}}"/>
          {{>rights}}
          <div id="graph"></div>
          {{>comments}}
          {{/authorized}}
        </main>
        <div class="col" id="leaves">
          <ul id="branch">
          {{#leaves}}
            <li class="{{type}}"><a href="{{href}}">{{name}}</a></li>
          {{/leaves}}
          </ul>
        </div>
      </div>
      <nav id="footer" class="{{>navbarstyle}} fixed-bottom">
        <div role="group">
          {{#editable}}
          <button class='btn btn-outline-light btn-sm' data-toggle="modal" data-target="#add_grounding" type="button">{{i18n.i_add_groundings}}</button>
          <button class='btn btn-outline-light btn-sm hidden' data-toggle="modal" data-target="#remove_grounding" id="remove_grounding_btn">{{i18n.i_remove_grounding}}</button>
          {{/editable}}
          <button class='btn navbar-btn btn-outline-light btn-sm' id="comment_create">{{i18n.i_comment}}</button>
        </div>
        <div id="add-leaves">
          {{#editable}}
          <div class="input-group input-group-sm">
            <input id="leave-name" type="search" placeholder="{{i18n.i_name.storyline}}" class="form-control input" />
            <div class="input-group-append">
              <span class="input-group-text storyline" title="{{i18n.i_create.storyline}}" id="add">+</span>
            </div>
          </div>
          {{/editable}}
        </div>
      </nav>
    </div>
    <div id="show-leaves" class="hidden"><div class="reverse">{{i18n.i_leaves}}</div></div>
    <div id="add_grounding" class="modal fade" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">{{i18n.i_add_groundings}}</div>
          <div class="modal-body">
            <select onChange="record('add_grounding', this.value);"><option>{{i18n.i_select_grounding}}</option></select>
          </div>
        </div>
      </div>
    </div>
    <div id="remove_grounding" class="modal fade" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">{{i18n.i_remove_grounding}}</div>
          <div class="modal-body">
            <select onChange="record('remove_grounding', this.value);"><option>{{i18n.i_select_grounding}}</option></select>
          </div>
        </div>
      </div>
    </div>
  {{>script}}
  <script src="../../script/vis.min.js"></script>
  <script>
  var connected_nodes = "{{connected_nodes}}".split(',');
  $(document).ready(function() {
    {{>render}}
    moment.locale('{{locale}}');
    var moments = $('.moment');
    moments.each(function() {
      var now = moment();
      var jstime = $(this).text();
      var mmtime = moment(jstime);
      if(now.diff(mmtime, 'days') <= 2) {
        $(this).text(mmtime.fromNow());
      } else if(now.diff(mmtime, 'years') <= 1) {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM"));
      } else {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM YYYY"));
      }
    });
    var container = document.getElementById('graph');
    var nodes = [];
    {{#nodes}}
      var label = wrap("{{label}}");
      var vertical = 'line-height: 90px;';
      if (label.length > 19) vertical = '';
      switch ("{{shape}}") {
        case ('box'):
          var shape = 'box';
          break;
        default:
          var shape = 'box';
          break;
      }
      var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="350" height="102">' +
        shape +
        '<foreignObject x="0" y="2" width="100%" height="100%">' +
        '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:2em; font-family: Helvetica; text-align: center; padding-right: 1em; padding-left: 1em; '+vertical+'">'+
        label+
        '</div></foreignObject></svg>';
      var image = "data:image/svg+xml;charset=utf-8,"+ encodeURIComponent(svg);
      nodes.push({
        id: "{{id}}",
        label: label,
        shape: shape
      });
    {{/nodes}}
    var edges = [];
    {{#edges}}
      {{^dashes}}
        edges.push({
          id: "{{id}}",
          from: "{{from}}",
          to: "{{to}}",
          color: "{{color}}"
        });
      {{/dashes}}
      {{#dashes}}
        var label = wrap("{{label}}");
        edges.push({
          from: "{{from}}",
          to: "{{to}}",
          label: label,
          dashes: true
        });
      {{/dashes}}
    {{/edges}}
    var data = {
      nodes: nodes,
      edges: edges
    };
    var options = {
      nodes: {
        color: {
          border: 'black',
          background: 'white',
          highlight:{
            border: 'black',
            background: 'white'
          }
        }
      },
      interaction: {
        navigationButtons: true,
        keyboard: true
      },
      layout: {
        randomSeed: 1,
        improvedLayout: true
      },
      physics: {
        barnesHut: {
          avoidOverlap: 1
        },
        repulsion: {
          nodeDistance: 100
        },
        solver: 'repulsion',
      }
    };
    var isolated_nodes = nodes.filter(function(a) { if (connected_nodes.indexOf(a.id) == -1) return a;});
    if (isolated_nodes.length > 0) record('clean_nodes', '');
    var network = new vis.Network(container, data, options);
    network.on('click', function (selected) {
      if (typeof selected.nodes[0] === "undefined" && selected.edges[0].length == 32) {
        self.location = "../../diagram/{{diary}}/"+selected.edges[0];
      } else if (selected.nodes[0].length == 32) {
        self.location = "../../memo/{{diary}}/"+selected.nodes[0];
      } else {}
    });
    $("#dialog").attr("title","{{i18n.i_groundings}}");
    $("#dialog").find('select').append($('<option>', {
      text: "{{i18n.i_select_grounding}}"
    }));
  });

  $('#add').on('click', function() {
    var classlist = $(this)[0].classList;
    create(classlist[classlist.length - 1], '{{_id}}', $('#leave-name').val().trim());
  });

  $('#add_grounding').on('show.bs.modal', function (event) {
    $.ajax({
      url: "../../memo_attribute/{{diary}}",
      type: "GET",
      dataType: "json",
        success: function(grounds) {
        for (var i in grounds.rows) {
          var r = grounds.rows[i];
          var id = r.value['id'];
          var ground_type = r.value['type'];
          var ground_label = r.value['name'];
          if(document.getElementById(id) == null && id != "{{_id}}" && ground_type == 'diagram') {
            $("#add_grounding").find('select').append($('<option>', {
              id: id,
              value: id,
              text: ground_label
            }));
          };
        }
      }
    });
  })

  $('#remove_grounding').on('show.bs.modal', function (event) {
    $('#groundings').children('li').each(function() {
      var id = ($(this).attr('id')),
          name = ($(this).find('a').text());
      if (name.length > 45) name = name.substr(0,45)+'...';
      $("#remove_grounding").find('select').append($('<option>', {
        value: id,
        text: name
      }));
    });
  });

  function wrap(t) {
    t = t.trim().replace(/&#39;/g, '\'').replace(/&quot;/g, '"');
    return t.substring(0, 12)+t.substring(12, 30).replace(/\s/,"\n")+t.substring(30, 50).replace(/\s/,"\n");
  }

  function record(action, what) {
    $.ajax({
      url: "../../"+what,
      type: "GET",
      dataType: "json",
      error: function(request) {
        alert(
          (JSON.parse(request.responseText).reason || request.responseText)
          + '\nCode ' + request.status
        );
      },
      success: function(added) {
        $.ajax({
          url: "../../{{_id}}",
          type: "GET",
          dataType: "json",
          success: function(data) {
            var keep_trace = true;
            switch(action) {
              case ('add_grounding'):
                var nodeids = data.nodes.map(function(a) {return a.id;});
                if (data.groundings.indexOf(what) == -1) data.groundings.push(what);
                switch (added.link) {
                  case ('pp'):
                  case ('ipp'):
                    if(nodeids.indexOf(added.groundings[0]) == -1) data.nodes.push({id: added.groundings[0], shape: 'box'});
                    if(nodeids.indexOf(added.groundings[1]) == -1) data.nodes.push({id: added.groundings[1], shape: 'box'});
                    break;
                  case ('dd'):
                  case ('idd'):
                    if(nodeids.indexOf(added.groundings[0]) == -1) data.nodes.push({id: added.groundings[0], shape: 'diamond'});
                    if(nodeids.indexOf(added.groundings[1]) == -1) data.nodes.push({id: added.groundings[1], shape: 'diamond'});
                    break;
                  case ('dp'):
                    if(nodeids.indexOf(added.groundings[0]) == -1) data.nodes.push({id: added.groundings[0], shape: 'box'});
                    if(nodeids.indexOf(added.groundings[1]) == -1) data.nodes.push({id: added.groundings[1], shape: 'diamond'});
                    break;
                }
              break;
              case ('remove_grounding'):
                var i = data.groundings.indexOf(what);
                if (i > -1) data.groundings.splice(i, 1);
              break;
              case ('clean_nodes'):
                data.nodes = data.nodes.filter(function(a) { if (connected_nodes.indexOf(a.id) > -1) return a;});
                keep_trace = false;
              break;
            }
            $.ajax({
              type: "PUT",
              url: "../../{{_id}}",
              contentType: "application/json",
              data: JSON.stringify(data),
              error: function(request) {
                alert(
                  (JSON.parse(request.responseText).reason || request.responseText)
                  + '\nCode ' + request.status
                );
              },
              success: function() {
                location.replace("{{_id}}")
              }
            });
          }
        });
      }
    });
  }

  {{>commentsscript}}
  {{>layoutscript}}
  {{>logscript}}
  {{#editable}}
    {{>editname}}
  {{/editable}}
  </script>
  </body>
</html>
