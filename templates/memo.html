<html>
  <head>
    <title>{{diary_name}} - {{name}}</title>
    {{>links}}
  </head>
  <body>
    <div id="container">
      <div id="header" class="menu">
        <button type="button" id="diary">{{diary_name}}</button>
        {{#authorized}}
        <button type='button' id='clear_highlights' hidden="hidden">{{i18n.i_raw}}</button>
        <button type='button' id='specific' class='highlight_words'
          disabled='disabled' hidden="hidden">{{i18n.i_specific}}</button>
        <button type='button' id='rare' class='highlight_words'
          disabled='disabled' hidden="hidden">{{i18n.i_rare}}</button>
        <button type='button' id='repeated' disabled='disabled' hidden="hidden">
          {{i18n.i_phrases}}</button>
        {{/authorized}}
        {{>log}}
        {{#authorized}}
        <input id='kwic' type='search' placeholder='{{i18n.i_search}}' hidden="hidden"/>
        {{/authorized}}
      </div>
      <div id="memo">
        {{#authorized}}
        <div id="groundings">
          <legend>{{i18n.i_groundings}}</legend>                   
          {{#groundings}}
          <li class="{{type}}" id="{{id}}">
            <h4 class="toggle">{{name}}</h4>
            <div class="preview">{{preview}} <a href="{{href}}">-></a></div>
          </li>            
          {{/groundings}}
          <div id="add-grounding"><span>{{i18n.i_add_groundings}}</span></div>
        </div>
        {{/authorized}}
        <div id="content">
          {{^authorized}}
          <h1 id="name">{{i18n.i_sign-in_required}}</h1>
          {{/authorized}}
          {{#authorized}}
          <div id="add-leaves">
            <input id="leave-name" type="search" placeholder="" hidden="hidden" />
            <button type="button" id="add" hidden="hidden">+</button>
            <button id="create" class="diagram" type="button" hidden="hidden">+</button>
            <button id="create-table" class="table" type="button" hidden="hidden">+</button>
          </div>
          <h1><img src="../../style/{{type}}.png"/> {{name}}</h1>
          <input id="name" type="search" hidden="hidden" value="{{name}}"/>
          <p id="authorization">
            {{i18n.i_created-by}} {{creator}} <span class="moment">{{date}}</span><br/>
            {{i18n.i_contributors}} <span id="contributors">{{contributors_fullnames}}</span>
            <button type="button" id="contributors_add">+</button>
            <input id="contributors_edit" type="search" hidden="hidden" /><br/>
            {{i18n.i_readers}} <span id="readers">{{readers_fullnames}}</span>
            <button type="button" id="readers_add">...</button>
            <input id="readers_edit" type="search" hidden="hidden" /><br/>
          </p>
          <div class="speeches">
          {{#body}}
          <div class="speeches-row">
            <div class="actor">
            {{#actor}}
            {{actor}}
            {{/actor}}
            </div>
            <div class="writing">
              {{#timestamp}}
              <div class="timestamp">{{timestamp}}</div>
              {{/timestamp}}
              <div class="post">
                {{#words}}<font>{{.}}</font>{{/words}}
                {{#text}}{{text}}{{/text}}
              </div>
            </div>
          </div>
          {{/body}}
          </div>
          <div id="comments">
            {{#comments}}
            <div class="comment {{checked}}" id="{{id}}" name="{{rev}}">
              <span class="meta"><span class="user">{{user}}</span> (<span class="moment">{{date}}</span>)</span>:
              {{#logged}}<div class="checkbox"><input type="checkbox" class="comment_check" {{checked}}></div>{{/logged}}<br/>
              <span class="comment_text">{{text}}</span>
              <input size="80" height="50" type="text" hidden="hidden" class="comment_edit" value="{{text}}"/>
            </div>
            {{/comments}}
            <button type="button" id="comment_create">{{i18n.i_comment}}</button>
            <textarea cols="80" rows="5" type="text" hidden="hidden" placeHolder="{{i18n.i_enter_comment}}"></textarea>
            <button type="button" id="commented" hidden="hidden">{{i18n.i_done}}</button>
          </div>
          <p>&nbsp;</p>
        {{/authorized}}
        </div>
        <div id="leaves">
          <ul id="branch">
          {{#leaves}}
            <li class="{{type}}"><a href="{{href}}">{{name}}</a></li>
          {{/leaves}}
          </ul>
        </div>
      </div>
      <div id="footer" class="menu">
        {{#authorized}}
        <button type="button" id="remove_grounding" hidden="hidden">{{i18n.i_remove_grounding}}</button>
        <button type="button" id="edit">{{i18n.i_edit}}</button>
        {{/authorized}}
        <a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </div>
    </div>
    <div id="show-leaves" hidden="hidden"><div class="reverse">{{i18n.i_leaves}}</div></div>
    <div id="dialog" title="{{i18n.i_groundings}}" hidden="hidden">
      <select onChange="record('+',this.value);"><option>{{i18n.i_select_grounding}}</option></select>
    </div>
    <div id="removable" title="{{i18n.i_groundings}}" hidden="hidden">
      <select onChange="record('-',this.value);"><option>{{i18n.i_select_grounding}}</option></select>
    </div>
  </body>
  {{>script}}
  <script src="../../script/showdown.min.js"></script>
  <script>
  var refresh = true;
  var metrics = {};
  var trigrams = {};
  var user = "{{peer}}";
  if ("{{logged}}") user = "{{logged}}";
  $(document).ready(function() {
    if ({{draft}}) self.location = "../../editable_text/{{_id}}";
    moment.locale('{{locale}}');
    var moments = $('.moment');
    moments.each(function() {
      var now = moment();
      var jstime = $(this).text();
      var mmtime = moment(jstime);
      if(now.diff(mmtime, 'days') <= 2) {
        $(this).text(mmtime.fromNow());
      } else if(now.diff(mmtime, 'years') <= 1) {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM"));
      } else {
        $(this).text("{{i18n.i_on-a-date}}"+' '+mmtime.format("Do MMMM YYYY"));
      }
    });
    switch ('{{type}}') {
      case ('field'):
        $("#name").attr("placeHolder", "{{i18n.i_name.field}}");
        $('#add').addClass('coding');
        $("#leave-name").attr("placeHolder", "{{i18n.i_name.coding}}");
        $('#clear_highlights').show();
        $('#specific').show();
        $('#rare').show();
        $('#repeated').show();
        $('#kwic').show();
        $('.writing').removeClass('writing').addClass('words');
        break;
      case ('coding'):
        $("#name").attr("placeHolder", "{{i18n.i_name.coding}}");
        $('#add').addClass('theoretical');
        $("#leave-name").attr("placeHolder", "{{i18n.i_name.theoretical}}");
        if ($('#name').val().length > 0) {
          $('#create').show();
          $('#create-table').show();
        }
        break;
      case ('theoretical'):
        $("#name").attr("placeHolder", "{{i18n.i_name.theoretical}}");
        $('#add').addClass('operational');
        $("#leave-name").attr("placeHolder", "{{i18n.i_name.operational}}");
        break;
      case ('operational'):
        $("#name").attr("placeHolder", "{{i18n.i_name.operational}}");
        $('#add').addClass('field');
        $("#leave-name").attr("placeHolder", "{{i18n.i_name.field}}");
        break;
      case ('diagram'):
        self.location = "../../diagram/{{diary}}/{{_id}}";
        break;
      case ('graph'):
        self.location = "../../graph/{{diary}}/{{_id}}";
        break;
      case ('storyline'):
        $("#name").attr("placeHolder", "{{i18n.i_name.storyline}}");
        $('#add').addClass('storyline');
        $("#leave-name").attr("placeHolder", "{{i18n.i_name.storyline}}");
        break;
    }
    stickToHeader();
    if ($('#name').val().length > 0) {
      $('#add').show();
      $('#leave-name').show();
    }
    if ($('#contributors').text().length < 1) {
      $('#contributors').before("{{i18n.i_everyone}}");
    }
    if ($('#readers').text().length < 1) {
      $('#readers').before("{{i18n.i_everyone}}");
    }
    var converter = new showdown.Converter({
      tables: 'true',
      tasklists: 'true',
      strikethrough: 'true'
    });
    $('.post').html(function(i, text) {
      return converter.makeHtml(text.trim());
    });
    if ($('#leaves li').length > 0) {
      $("#show-leaves").show();
    }
    if ($('#groundings li').length > 1) $('#remove_grounding').show();
    if ($('#groundings li').length < 1) {
      $("#groundings").css({
        'visibility': 'hidden'
      });
      $("#add-grounding").css({
        'visibility': 'visible'
      });
      $("#add-grounding").css({
        'height': '36px',
        'line-height': '36px',
        'position':'fixed',
        'top': '2px',
        'left': '0px',
        'padding-bottom':'0px',
        'transform': 'rotate(90deg)',
        'transform-origin': 'left bottom 0'
      });
      $("#add-grounding span").css({
        'position':'absolute',
        'left':'0',
        'right':'0',
        'transform': 'rotate(180deg)',
        'transform-origin': 'center center 0'
      });
      $("#content").css({
         'padding-left': '40px'
      });
      $("#comments").css({
         'margin-left': '40px',
      });
    }
    if ("{{type}}" === 'field') {
      $.ajax({
        url: "../../corpus_words/{{diary}}",
        type: "GET",
        dataType: "json",
        success: function(lexcorpus) {
          var corpus = {};
          for (var i in lexcorpus.rows) {
            var c = lexcorpus.rows[i];
            corpus[c.key[1]] = c.value;
          }
          $.ajax({
            url: "../../text_words/{{_id}}",
            type: "GET",
            dataType: "json",
            success: function(lexdoc) {
              var max_specific = 0;
              for (var j in lexdoc.rows) {
                var d = lexdoc.rows[j];
                var word = d.key[1];
                var inCorpus = corpus[word];
                metrics[word] = {
                  rare: 1/inCorpus.sum,
                  specific: Math.sqrt(d.value)/inCorpus.count,
                };
                max_specific = Math.max(max_specific, metrics[word].specific);
              }
              for (var k in metrics) {
                var m = metrics[k];
                m.specific /= max_specific;
              }
              $('#rare').removeAttr('disabled');
              $('#specific').removeAttr('disabled');
            }
          });
        }
      });
      $.ajax({
        url: "../../phrase/{{diary}}",
        type: "GET",
        dataType: "json",
        success: function(phrases) {
          for (var l in phrases.rows) {
            var r = phrases.rows[l];
            trigrams[[r.key[1], r.key[2], r.key[3]]] = r.value;
          }
          $('#repeated').removeAttr('disabled');
        }
      });
    }
    $.ajax({
      url: "../../changes/memo/{{_id}}/{{update_seq}}",
      type: "GET",
      dataType: "json",
      success: reload
    });
  });

  $('#contributors_add').on('click', function() {
    $('#contributors_add').hide();
    $('#contributors_edit').show();
  });

  $('#contributors_edit').on('keypress', function(key) {
    if (key.which == 13) {
      record('+','contributors');
    }
  });

  $('#leave-name').on('keypress', function(key) {
    if ("{{type}}" != 'coding' && key.which == 13) {
      var type = $(this)[0].nextElementSibling.className;
      create(type);
    }
  });

  $('#readers_add').on('click', function() {
    $('#readers_add').hide();
    $('#readers_edit').show();
  });

  $('#readers_edit').on('keypress', function(key) {
    if (key.which == 13) {
      record('+','readers');
    }
  });

  $('#groundings').find('.toggle').click(function(){
    $(this).next().slideToggle('fast');
    $(".preview").not($(this).next()).slideUp('fast');
  });

  $("#show-leaves").click(function () {
    var option = { direction: 'left' };
    $('#leaves').toggle('fold');
  });

  $('#diary').on('click', function() {
    self.location = '../{{diary}}/?by=date';
  });

  $('#edit').on('click', function() {
    if ('{{type}}' == 'field') { self.location = '../../editable_text/{{_id}}';} 
    else { self.location = '../../editable_memo/{{_id}}';}
  });

  $('h1').on('click', function() {
    $(this).hide();
    $('#leave-name').hide();
    $('#name').show();
  });

  $('#name').on('keypress', function(key) {
    if (key.which == 13) {
      if ($('#name').val().trim() == '') {
        alert("{{i18n.i_enter_memo_name}}")
      } else {
        record('...','name');
      }
    }
  });

  $('#remove_grounding').on('click', function() {
    $('#groundings').children('li').each(function() {
      $("#removable").find('select').append($('<option>', {
        value: ($(this).attr('id')),
        text: ($(this).find('h4').html())
      }));
    });
    $("#removable").dialog({
      autoOpen: true,
      modal: true,
      autoResize: true,
      width:'auto'
    });
  });

  $('#add').on('click', function() {
    var type = $(this)[0].className;
    create(type);
  });

  $('#create').on('click', function() {
    var type = $(this)[0].className;
    create(type);
  });

  $('#create-table').on('click', function() {
    var type = $(this)[0].className;
    create(type);
  });

  $('#add-grounding').on('click', function() {
    $.ajax({
      url: "../../memo_attribute/{{diary}}",
      type: "GET",
      dataType: "json",
      success: function(ground_candidates) {
        for (var i in ground_candidates.rows) {
          var r = ground_candidates.rows[i];
          var id = r.value['id'];
          if(document.getElementById(id) == null && id != "{{_id}}") {
            $("#dialog").find('select').append($('<option>', {
              value: id,
              text: r.value['name']
            }));
          }
        }
        $("#dialog").dialog({
          autoOpen: true,
          modal: true,
          autoResize: true,
          width:'auto'
        });
      }
    });
  });

  function create(type) {
    if ($('#leave-name').val().trim() == '' && type != 'diagram') {
      alert("{{i18n.i_enter_memo_name}}")
    } else {
      var diary = "{{diary}}";
      var contributors = "{{contributors}}";
      var data = {
        groundings: [],
        history : []
      };
      data.history.push({
        "user": user,
        "date": new Date().toJSON()
      });
      if (contributors.length > 0) {
        data.contributors = contributors.split(',');
      } else if ("{{logged}}") {
        data.contributors = ["{{logged}}"];
      }
      var readers = "{{readers}}";
      if (readers.length > 0) {
        data.readers = readers.split(',');
      }
      switch (type) {
        case 'field':
          var destination = '../../editable_text/';
          data.corpus = diary,
          data.name = $('#leave-name').val().trim(),
          data.speeches = [{actor:"",text:""}];
        break;
        case 'table':
          var destination = "../../table/{{diary}}/";
          data.cells = [{'...':[{"{{_id}}":'...'}]}];
          data.diary = diary;
          data.name = $('#leave-name').val().trim(),
          data.type = type;
        break;
        case 'diagram':
          var destination = "../../diagram/{{diary}}/";
          data.diary = diary;
          data.link = 'pp';
          data.name = $('#name').val();
          data.type = type;
        break;
        default:
          var destination = '../../editable_memo/';
          data.diary = diary,
          data.body = "";
          data.name = $('#leave-name').val().trim(),
          data.type = type;
      }
      data.groundings.push("{{_id}}");
      if (diary) {
        $.ajax({
          url: "../../",
          type: "POST",
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify(data),
          success: function(data) {
            self.location = destination+data.id;
          }
        });
      }
    }
  }

  function renameDiagram(id,name) {
    $.ajax({
      url: '../../'+id,
      type: "GET",
      dataType: "json",
      success: function(diagram) {
        var properties = diagram.name.split('&');
        if (diagram.groundings[0] == "{{_id}}") {
          diagram.name = name+' & '+ properties[1].trim();
        } else {
          diagram.name = properties[0].trim() +' & '+name;
        }
        $.ajax({
          type: "PUT",
          url: '../../'+id,
          contentType: "application/json",
          data: JSON.stringify(diagram)
        });
      }
    });
  }

  function record(action, what) {
    $.ajax({
      url: "../../{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(data) {
        switch(what) {
          case ('contributors'):
            var newcontributor = $('#contributors_edit').val().trim().toLowerCase();
            if (!data.contributors) data.contributors = [];
            data.contributors.push(newcontributor);
          break;
          case ('readers'):
            var newreader = $('#readers_edit').val().trim().toLowerCase();
            if (!data.readers) data.readers = [];
            data.readers.push(newreader);
          break;
          case ('name'):
            data.name = $('#name').val().trim();
            var history = {
              "user": user,
              "date": new Date().toJSON()
            };
            if (!data.history) data.history = [];
            data.history.push(history);
            if ("{{type}}" == 'coding') {
              {{#leaves}}
              if ("{{type}}" == 'diagram') {
                renameDiagram("{{href}}".split('/').pop(),data.name);
              }
              {{/leaves}}
            }
          break;
          default:
            if (action == '+') {
              if (!data.groundings) data.groundings = [];
              if (data.groundings.indexOf(what) == -1) data.groundings.push(what);
            } else {
              var i = data.groundings.indexOf(what);
              if (i > -1) data.groundings.splice(i, 1);
            }
        }
        $.ajax({
          type: "PUT",
          url: "../../{{_id}}",
          contentType: "application/json",
          data: JSON.stringify(data),
          error: function(request) {
            alert(
              (JSON.parse(request.responseText).reason || request.responseText)
              + '\nCode ' + request.status
            );
          }
        });
      }
    });
  }

  function toColor(metrics) {
    var grayLevel = Math.floor(255*(1-metrics)).toString(16);
    return '#' + grayLevel + grayLevel + grayLevel;
  }

  $('#clear_highlights').on('click', function() {
    $('font').each(function() {
      $(this).removeAttr('color');
    });
  });

  $('.highlight_words').on('click', function() {
    var type = this.id;
    $('font').each(function() {
      $(this).attr('color', toColor(wordMetrics(metrics, $.trim($(this).text()), type)));
    });
  });

  $('#repeated').on('click', function() {
    var words = [];
    $('font').each(function(i) {
      words[i] = {text: $.trim($(this).text()).toLowerCase()};
    });
    words[0].count = 0;
    words[1].count = 0;
    var max = 0;
    for (w=0; w<words.length-2; w++) {
      var nb = trigrams[[words[w].text, words[w+1].text, words[w+2].text]];
      if (!nb) nb = 1;
      words[w].count = Math.max(words[w].count, nb);
      words[w+1].count = Math.max(words[w+1].count, nb);
      words[w+2].count = nb;
      max = Math.max(max, words[w].count);
    }
    $('font').each(function(i) {
      $(this).attr('color', toColor(words[i].count/max));
    });
  });

  function wordMetrics(metrics, word, type) {
    var w = metrics[word.toLowerCase()];
    return (w)?w[type]:.05;
  }

  String.prototype.trimLeft = String.prototype.trimLeft || function() {
    return this.replace(/^\s+/,'');
  };

  $('#content').on('mouseup', function() {
    $('#kwic').val(
      document.getSelection().toString().trimLeft()
    );
  });

  $('#kwic').on('keypress', function(key) {
    if (key.which == 13) {
      self.location = '../../kwic/{{diary}}/' + $('#kwic').val().toLowerCase();
    }
  });

  {{>commentsscript}}
  {{>layoutscript}}
  {{>logscript}}
  </script>
</html>
