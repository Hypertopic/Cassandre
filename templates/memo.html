<html>
  <head>
    <title>{{name}} ({{diary}})</title>
    <link rel="icon" type="image/png" href="../../style/favicon.png" />
    <link rel="stylesheet" type="text/css" href="../../style/main.css" />


  </head>
  <body>
    <div id="container">
      <div id="header" class="menu">
        <button type="button" id="diary">{{diary}}</button>
      </div>
      <div id="memo">
        <div id="groundings" >
          <legend>{{i18n.i_groundings}}</legend>                   
          {{#groundings}}
          <li id="{{.}}">
            <h4 class="toggle"></h4>
            <div class="preview"></div>
          </li>            
          {{/groundings}}
          <div id="add-grounding">{{i18n.i_add_groundings}}</div>
        </div>
        <div id="content">
          <h1> <img src="../../style/{{type}}.png"/> {{name}} <button type="button" id="add">+</button>
            <button id="create" class="diagram" type="button" hidden="hidden">+</button>
          </h1>
          <p>
            {{user}}<br/>{{date}}
            <button type="button" id="edit">{{i18n.i_edit}}</button>
          </p>
          <div class="speeches">
          {{#body}}
          <div class="speeches-row">
            <div class="actor">
            {{#actor}}
            {{actor}}
            {{/actor}}
            </div>
            <div class="words">
              {{#timestamp}}
              <div class="timestamp">{{timestamp}}</div>
              {{/timestamp}}
              <div class="post">
                {{#text}}{{text}}{{/text}}
              </div>
            </div>
          </div>
          {{/body}}
          </div>
        </div>
        <div id="leaves">
          <ul id="branch">
          </ul>
        </div>
      </div>
      <div id="footer" class="menu">
        <a href="https://github.com/Hypertopic/Cassandre/wiki">Cassandre</a>
      </div>
    </div>
    <div id="show-leaves"><div class="reverse">{{i18n.i_leaves}}</div></div>
    <div id="dialog" title="{{i18n.i_groundings}}" hidden="hidden">
        <select onChange="save(this);"><option>{{i18n.i_select_grounding}}</option></select>
    </div>
  </body>
  <script src="../../script/jquery.js"></script>
  <script src="http://code.jquery.com/ui/1.11.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.1/themes/smoothness/jquery-ui.css" />
  <script>
  $(document).ready(function() {
    switch ('{{type}}') {
      case ('field'):
        $('#add').addClass('coding');
        break;
      case ('coding'):
        $('#add').addClass('theoretical');
        $('#create').show();
        break;
      case ('theoretical'):
        $('#add').addClass('operational');
        break;
      case ('operational'):
        $('#add').addClass('field');
        break;
      case ('diagram'):
        $('#add').addClass('diagram');
        break;
    }
    $.ajax({
      url: "../../memo_attribute/{{{diary}}}",
      type: "GET",
      dataType: "json",
        success: function(grounds) {
        for (var i in grounds.rows) {
          var r = grounds.rows[i];
          var diary = r.key;
          var id = '#' + r.value['id'];
          var ground_href = r.value['id'];
          var ground_type = r.value['type'];
          if (ground_type == 'diagram') {
            var ground_path = "../../diagram/{{{diary}}}/";
          } else {
            var ground_path = '';
          }
          var ground_label = r.value['name'];
          var ground_date = r.value['date']; // unused
          var ground_preview = r.value['preview'];
          if(document.getElementById(ground_href) == null && ground_href != "{{_id}}") {
            $("#dialog").find('select').append($('<option>', {
              value: ground_href,
              text: ground_label
            }));
          } else {
            $(id).addClass(ground_type);
            $(id).find("h4").text(ground_label);
            $(id).find("div").text(ground_preview);
            var link = document.createElement("a");
            link.setAttribute('href', ground_path+ground_href);
            $(id).find("div").append(link);
            $(id).find("div").find("a").text('->');
          };
        }
      }
    });
    $.ajax({
      url: "../../leaves/{{_id}}",
      type: "GET",
      dataType: "json",
      success: function(leaves) {
        for (var i in leaves.rows) {
          var r = leaves.rows[i];
          var leaf_type = r.value['type'];
          if (leaf_type == 'diagram') {
            var leaf_href = "../../diagram/{{{diary}}}/"+r.value['id']
          } else {
            var leaf_href = r.value['id'];
          }
          var leaf_label = r.value['name'];
          $("#leaves ul").append('<li class="'+leaf_type+'"><a href="'+leaf_href+'">'+leaf_label+'</a></li>');              
        }
        if (leaves.rows.length < 1) {
          $("#show-leaves").remove();
        }
        if ($('#groundings li').length < 1) {
          $("#groundings").find('legend').remove();
          $("#groundings").css({
             'position': 'absolute',
             'height': '31px',
             'line-height': '31px',
             'top': '0px',
             'padding-top': 'auto',
             'padding-left': '5px',
             'padding-right': '5px',
             'width': '200px',
             'height': 'auto',
             'transform': 'rotate(90deg)',
             'transform-origin': 'bottom left 0',
          });
          $("#add-grounding").css({
             'bottom': 'auto',
             'top': '0px',
             'width': 'auto',
             'transform': 'rotate(180deg)',
             'transform-origin': 'center center 0',
          });
          $("#content").css({
             'margin-left': '30px',
          });
        }
      }
    }); 
  });

  $('#groundings').find('.toggle').click(function(){
    $(this).next().slideToggle('fast');
    $(".preview").not($(this).next()).slideUp('fast');
  });

  $("#show-leaves").click(function () {
    var option = { direction: 'left' };
    $('#leaves').toggle('fold');
  });

  $('#diary').on('click', function() {
    var diaryUrl = encodeURIComponent("{{{diary}}}");
    self.location = '../'+diaryUrl+'/?by=name';
  });

  $('#edit').on('click', function() {
    if ('{{type}}' == 'field') { self.location = '../../editable_text/{{_id}}';} 
    else { self.location = '../../editable_memo/{{_id}}';}
  });

  $('#add').on('click', function() {
    var type = $(this)[0].className;
    create(type);
  });

  $('#create').on('click', function() {
    var type = $(this)[0].className;
    create(type);
  });

  $('#add-grounding').on('click', function() {
    $("#dialog").dialog({
      autoOpen: true,
      modal: true,
      autoResize: true,
      width:'auto'
    });
  });

  function save(there) {
    var data = {
      groundings: [],
      _rev: "{{_rev}}",
      date: "{{date}}",
      diary: "{{{diary}}}",
      name: "{{{name}}}",
      type: "{{type}}",
      user: "{{user}}"
    };
    $('#groundings').children('li').each(function() {
      data.groundings.push($(this).attr('id'));
    });
    var content = [];
    $('.speeches-row').each(function() {
      var turn = {
        text: $(this).find('.post').text().trim()
      };
      var actor = $(this).find('.actor').text().trim();
      if (actor) {
        turn.actor = actor;
      }
      content.push(turn);
    });
    if (content[0] == null){
      data.body = '';
    } else if (content[0].actor == null){
      data.body = content[0].text;
    } else {
      data.speeches = content;
    }
    data.groundings.push(there.value);
    $.ajax({
      type: "PUT",
      url: "../../{{_id}}",
      contentType: "application/json",
      data: JSON.stringify(data),
      error: function(request) {
        alert(
          (JSON.parse(request.responseText).reason || request.responseText)
          + '\nCode ' + request.status
        );
      },
      success: function() {
        location.replace("{{_id}}")
      }
    });
  }

  function create(type) {
    var diary = "{{{diary}}}";
    var data = {
      date: new Date().toJSON().substring(0,10),
      groundings: [],
      user: "unidentified.researcher"
    };
    switch (type) {
      case 'field':
        var destination = '/editable_text/';
        data.corpus = diary,
        data.name = "",
        data.speeches = [{actor:"",text:""}];
        break;
      case 'diagram':
        var destination = "/diagram/{{{diary}}}/";
        data.diary = diary;
        data.link = 'pp';
        data.name = "{{{name}}}";
        data.type = type;
        break;
      default:
        var destination = '/editable_memo/';
        data.diary = diary,
        data.body = "";
        data.name = "",
        data.type = type;
    }
    data.groundings.push("{{_id}}");
    if (diary) {
      $.ajax({
        url: "../../",
        type: "POST",
        dataType: "json",
        contentType: "application/json",
        data: JSON.stringify(data),
        success: function(data) {
          location.replace(destination+data.id)
        }
      });
    }
  }
  </script>
</html>
